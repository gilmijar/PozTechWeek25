
version: 2

models:
  - name: int_rental
    description: "precursor to fact"
    columns:
        - name: rental_id
          description: "Main business key"
          data_tests:
              - unique
              - not_null
        - name: inventory_id
          data_tests:
            - fast_distinct_check:
                arguments: 
                  target_count: 1194

  - name: top_customers
    columns:
      - name: customer_id
      - name: customer_name
      - name: customers.birth_year
      - name: total_rental_amount
      - name: customer_rank

sources:
  - name: landing
    tables:
      - name: store
        columns:
          - name: store_id
            data_tests:
              - unique
              - not_null
      - name: address
        columns:
          - name: address_id
            data_tests:
              - unique
              - not_null
      - name: customer
        columns:
          - name: customer_id
            data_tests:
              - unique
              - not_null
      - name: payment
        columns:
          - name: payment_id
            data_tests:
              - unique
              - not_null
          # Business says each payment is for 1 rental
          - name: rental_id
            data_tests:
              - unique
              - not_null
      - name: staff
        columns:
          - name: staff_id
            data_tests:
              - unique
              - not_null
      - name: country
        columns:
          - name: country_id
            data_tests:
              - unique
              - not_null
      - name: car
        columns:
          - name: car_id
            data_tests:
              - unique
              - not_null
      - name: inventory
        columns:
          - name: inventory_id
            data_tests:
              - unique
              - not_null
      - name: rental
        columns:
          - name: rental_id
            data_tests:
              - unique
              - not_null
      - name: equipment
        columns:
          - name: equipment_id
            data_tests:
              - unique
              - not_null
      - name: city
        columns:
          - name: city_id
            data_tests:
              - unique
              - not_null
      - name: inventory_equipment
      
unit_tests:
  - name: test_top_customers_ranks_returns_at_least_10_results
    description: "
    model: dim_customers
    given:
      - input: ref('stg_customers')
        rows:
          - {email: cool@example.com,    email_top_level_domain: example.com}
          - {email: cool@unknown.com,    email_top_level_domain: unknown.com}
          - {email: badgmail.com,        email_top_level_domain: gmail.com}
          - {email: missingdot@gmailcom, email_top_level_domain: gmail.com}
      - input: ref('top_level_email_domains')
        rows:
          - {tld: example.com}
          - {tld: gmail.com}
    expect:
      rows:
        - {email: cool@example.com,    is_valid_email_address: true}
        - {email: cool@unknown.com,    is_valid_email_address: false}
        - {email: badgmail.com,        is_valid_email_address: false}
        - {email: missingdot@gmailcom, is_valid_email_address: false}